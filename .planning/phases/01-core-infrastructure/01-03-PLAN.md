---
phase: 01-core-infrastructure
plan: 03
type: execute
wave: 3
depends_on:
  - 01-01
  - 01-02
files_modified:
  - src/plugins/voice_input/plugin.py
  - src/plugins/voice_input/plugin.yaml
  - src/plugins/daily_writer/plugin.py
  - src/plugins/daily_writer/plugin.yaml
  - src/core/transcriber.py
  - launchd/com.butler.voicewatch.plist
  - tests/plugins/test_voice_input.py
  - tests/plugins/test_daily_writer.py
autonomous: true
requirements:
  - VOICE-01
  - VOICE-02
  - VOICE-03
  - VOICE-04
  - OUTPUT-01
  - OUTPUT-02
  - OUTPUT-03
  - OUTPUT-04
must_haves:
  truths:
    - Voice input plugin watches folder and transcribes audio files
    - parakeet-mlx performs local transcription on Apple Silicon
    - Transcribed text emits input.received event
    - launchd plist watches Voice Memos folder
    - Daily writer subscribes to note.routed and appends to YYYY-MM-DD.md
    - Notes include timestamps and Obsidian frontmatter
    - note.written event emitted with metadata
    - All file writes use safe_write protocol
  artifacts:
    - path: src/plugins/voice_input/plugin.py
      provides: Voice memo transcription
      exports: ["VoiceInputPlugin"]
    - path: src/plugins/daily_writer/plugin.py
      provides: Daily note writing
      exports: ["DailyWriterPlugin"]
    - path: src/core/transcriber.py
      provides: parakeet-mlx wrapper
      exports: ["Transcriber", "TranscriptionError"]
    - path: launchd/com.butler.voicewatch.plist
      provides: macOS folder watching
      min_size: 500
  key_links:
    - from: src/plugins/voice_input/plugin.py
      to: src/core/event_bus.py
      via: input_received.send()
      pattern: "input_received.send('voice_input', text=..., source='voice')"
    - from: src/plugins/voice_input/plugin.py
      to: src/core/transcriber.py
      via: Transcriber.transcribe()
      pattern: "transcriber.transcribe(audio_path)"
    - from: src/plugins/daily_writer/plugin.py
      to: src/core/event_bus.py
      via: Subscribes to note_routed
      pattern: "@note_routed.connect"
    - from: src/plugins/daily_writer/plugin.py
      to: src/core/safe_write.py
      via: safe_write()
      pattern: "safe_write(filepath, content)"
---

<objective>
Implement core plugins: voice input and daily writer. These validate the end-to-end flow:
voice memo → transcription → event → routing → daily note → Obsidian file.

Purpose: Prove the MVP works - voice memos from iPhone appear in Obsidian automatically.

Output: Working voice input and daily writer plugins with launchd integration.
</objective>

<execution_context>
@/Users/caffae/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
@.planning/phases/01-core-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-core-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transcriber Module</name>
  <files>src/core/transcriber.py, tests/core/test_transcriber.py</files>
  <action>
    Create parakeet-mlx wrapper:
    - Lazy-load model on first transcription (avoid startup delay)
    - transcribe(audio_path: str) -> TranscriptionResult
    - TranscriptionResult: text, confidence, duration
    - Confidence threshold filtering (skip low-confidence)
    - Error handling for missing files, bad audio
    - Model warmup option for dev/testing
    
    Considerations:
    - Model is ~300MB, first load takes ~2s
    - Cache model instance (don't reload)
    - Handle MLX framework initialization
    
    Dependencies: parakeet-mlx (from requirements.txt)
    
    Test: Mock transcription (skip model load in unit tests), error handling.
  </action>
  <verify>python -m pytest tests/core/test_transcriber.py -v</verify>
  <done>Transcriber loads model lazily; returns text+confidence; handles errors</done>
</task>

<task type="auto">
  <name>Task 2: Voice Input Plugin</name>
  <files>src/plugins/voice_input/plugin.py, src/plugins/voice_input/plugin.yaml, tests/plugins/test_voice_input.py</files>
  <action>
    Implement voice input plugin:
    - Watch configured folder (default: ~/Music/Voice Memos)
    - On file detected: transcribe via Transcriber
    - If confidence > threshold: emit input.received event
    - If confidence low: log warning, skip
    - Move processed files to processed/ subfolder (configurable)
    - Handle duplicate files (SHA check)
    
    Plugin manifest (plugin.yaml):
    - name: voice_input
    - version: 1.0.0
    - enabled: true
    - capabilities_provided: [audio_input]
    - events_emits: [input.received]
    - config: watch_path, confidence_threshold, move_processed
    
    API:
    - scan_folder(): Manual scan (for testing)
    - process_file(path): Process single file
    
    Test: File detection, transcription flow, event emission, duplicate handling.
  </action>
  <verify>python -m pytest tests/plugins/test_voice_input.py -v</verify>
  <done>Plugin detects audio files; transcribes; emits input.received; moves processed</done>
</task>

<task type="auto">
  <name>Task 3: launchd Plist</name>
  <files>launchd/com.butler.voicewatch.plist, scripts/install_launchd.sh</files>
  <action>
    Create launchd configuration:
    - Label: com.butler.voicewatch
    - WatchPaths: /Users/$USER/Music/Voice Memos
    - ProgramArguments: butler process-voice
    - RunAtLoad: false (only on file changes)
    - StandardOutPath: ~/.butler/logs/voicewatch.log
    - StandardErrorPath: ~/.butler/logs/voicewatch.error.log
    
    Install script:
    - Copies plist to ~/Library/LaunchAgents/
    - Replaces $USER placeholder
    - Runs launchctl load
    - Verifies with launchctl list
    
    Document:
    - Manual install: cp plist → load
    - Uninstall: launchctl unload → rm plist
    - Debug: check logs, list status
    
    Test: Load/unload cycle, file change triggers, log output.
  </action>
  <verify>bash scripts/install_launchd.sh && launchctl list | grep butler</verify>
  <done>Plist installs; launchd triggers on file changes; logs written</done>
</task>

<task type="auto">
  <name>Task 4: Daily Writer Plugin</name>
  <files>src/plugins/daily_writer/plugin.py, src/plugins/daily_writer/plugin.yaml, tests/plugins/test_daily_writer.py</files>
  <action>
    Implement daily writer plugin:
    - Subscribe to note.routed events (via @note_routed.connect)
    - Filter for destination="daily"
    - Append to YYYY-MM-DD.md in vault/Daily/
    - Format: ## HH:MM header, then content, then source link
    - Obsidian frontmatter on new files:
      ```yaml
      ---
      date: YYYY-MM-DD
      ---
      ```
    - Emit note.written event with path, timestamp, word_count, source
    - Use safe_write for all file operations
    
    Plugin manifest:
    - name: daily_writer
    - events_listens: [note.routed]
    - events_emits: [note.written]
    - config: vault_path, daily_folder, timezone
    
    Edge cases:
    - Vault path doesn't exist: create directory
    - File open in Obsidian: safe_write handles race
    - Very long content: wrap gracefully
    
    Test: Note routing, file creation, appending, event emission, safe write.
  </action>
  <verify>python -m pytest tests/plugins/test_daily_writer.py -v</verify>
  <done>Plugin writes to daily files; adds frontmatter; emits note.written; uses safe_write</done>
</task>

<task type="auto">
  <name>Task 5: End-to-End Integration Test</name>
  <files>tests/integration/test_voice_to_obsidian.py</files>
  <action>
    Create integration test validating full MVP flow:
    1. Place test audio file in watched folder
    2. Trigger voice input processing
    3. Verify input.received event emitted
    4. Simulate note.router (emit note.routed)
    5. Verify daily file created/modified
    6. Verify note.written event emitted
    7. Check file content format (timestamp, content, source)
    
    Mock:
    - Transcriber (return test text)
    - Note router (route everything to daily)
    
    Real:
    - Event bus
    - File operations
    - Safe write
    
    Test covers complete path from voice file to Obsidian note.
  </action>
  <verify>python -m pytest tests/integration/test_voice_to_obsidian.py -v</verify>
  <done>Full flow works: voice file → transcription → event → daily file → Obsidian format</done>
</task>

</tasks>

<verification>
1. Manual test: Place audio file → verify transcription → check Obsidian file
2. Event flow: input.received → note.routed → note.written chain works
3. Safe write: Concurrent access doesn't corrupt files
4. launchd: File creation triggers processing
5. Format: Obsidian frontmatter present, wikilinks work
</verification>

<success_criteria>
- Voice input transcribes audio and emits events
- Daily writer appends to YYYY-MM-DD.md with frontmatter
- launchd triggers on file changes
- Safe write prevents corruption
- Integration test passes
- Manual test: iPhone voice memo → appears in Obsidian
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-03-SUMMARY.md`
</output>

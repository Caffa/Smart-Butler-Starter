---
phase: 01-core-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/install.sh
  - src/cli/doctor.py
  - src/cli/main.py
  - requirements.txt
  - pyproject.toml
  - README.md
autonomous: true
requirements:
  - INSTALL-01
  - INSTALL-02
  - INSTALL-03
must_haves:
  truths:
    - install.sh creates ~/.butler/ structure with friendly personality
    - butler doctor checks dependencies and downloads models
    - Git tags mark rollback checkpoints at each stage
    - CLI entry point works: butler --help
    - All dependencies installable via pip
  artifacts:
    - path: scripts/install.sh
      provides: One-command installation
      min_size: 1000
    - path: src/cli/doctor.py
      provides: Dependency checking
      exports: ["check_dependencies", "download_models"]
    - path: src/cli/main.py
      provides: CLI entry point
      exports: ["main"]
    - path: requirements.txt
      provides: Python dependencies
      contains: ["blinker", "huey", "pyyaml", "psutil"]
  key_links:
    - from: scripts/install.sh
      to: ~/.butler/
      via: Directory creation and file copy
      pattern: "mkdir -p ~/.butler/{logs,plugins,data}"
    - from: src/cli/doctor.py
      to: Ollama, parakeet-mlx
      via: Version checks and model downloads
      pattern: "ollama.pull('llama3.1:8b')"
---

<objective>
Create installation and CLI infrastructure. Users should install with one command and validate with butler doctor.

Purpose: Lower barrier to entry, ensure all dependencies present, provide rollback checkpoints.

Output: install.sh script, butler doctor command, CLI entry point, dependency management.
</objective>

<execution_context>
@/Users/caffae/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project Structure and Dependencies</name>
  <files>pyproject.toml, requirements.txt, README.md</files>
  <action>
    Set up Python project:
    - pyproject.toml with package metadata, dependencies, entry points
    - requirements.txt for pip install
    - Package structure: src/butler/ with __init__.py
    - Entry point: butler = butler.cli.main:main
    - Development dependencies: pytest, black, mypy
    - README with quick start and install instructions
    
    Dependencies (from research):
    - blinker>=1.9.0 (event bus)
    - huey>=2.6.0 (task queue)
    - pyyaml>=6.0 (config)
    - psutil>=5.9.0 (throttling)
    - parakeet-mlx (transcription)
    - ollama>=0.6.1 (AI)
    - chromadb>=1.5.0 (memory)
    
    Test: pip install -e . works, butler --help shows usage.
  </action>
  <verify>pip install -e . && butler --help</verify>
  <done>Package installs; CLI shows help; all deps resolvable</done>
</task>

<task type="auto">
  <name>Task 2: install.sh Script</name>
  <files>scripts/install.sh</files>
  <action>
    Create friendly install script:
    - Detect OS (macOS only for now)
    - Check Python 3.11+ installed
    - Create ~/.butler/ directory structure:
      - ~/.butler/config.yaml (default config)
      - ~/.butler/logs/
      - ~/.butler/plugins/
      - ~/.butler/data/
    - Clone repo or pip install butler
    - Install launchd plist
    - Run butler doctor to verify
    - Print success message with next steps
    - Friendly, conversational tone ("Hello! I'm Butler...")
    
    Safety:
    - Check for existing installation (prompt to overwrite)
    - Backup existing config before replacing
    - Set proper permissions
    
    Usage: curl -sSL https://.../install.sh | bash
    
    Test: Run in clean environment, verify all directories created.
  </action>
  <verify>bash scripts/install.sh --dry-run</verify>
  <done>Script creates directories; installs package; sets up launchd; friendly output</done>
</task>

<task type="auto">
  <name>Task 3: butler doctor Command</name>
  <files>src/cli/doctor.py, tests/cli/test_doctor.py</files>
  <action>
    Implement dependency checker:
    - Check Python version (3.11+)
    - Check macOS version (14.0+ for Apple Silicon features)
    - Check Ollama installed and running
    - Download models if needed (llama3.1:8b, nomic-embed-text)
    - Check parakeet-mlx can load
    - Check SQLite available
    - Check disk space (>1GB free)
    - Check write permissions to ~/.butler/
    - Report status with emoji indicators: ✓ / ✗ / ⚠
    
    Commands:
    - butler doctor: Full check
    - butler doctor --fix: Auto-download missing models
    
    Output format:
    ```
    Butler Health Check
    ===================
    
    ✓ Python 3.11.5
    ✓ macOS 14.2
    ✓ Ollama 0.6.1
    ✓ Model llama3.1:8b
    ⚠ Disk space: 2.1GB free (recommend 5GB+)
    ✓ Write permissions
    
    Status: Ready to go!
    ```
    
    Test: Check passes when deps present, fails gracefully when missing.
  </action>
  <verify>python -m pytest tests/cli/test_doctor.py -v && butler doctor</verify>
  <done>Doctor checks all deps; downloads models; reports status clearly</done>
</task>

<task type="auto">
  <name>Task 4: Git Rollback Checkpoints</name>
  <files>.github/workflows/tag-checkpoints.yml</files>
  <action>
    Set up Git tagging workflow:
    - Tag format: phase-01-plan-01, phase-01-complete, phase-02-plan-01, etc.
    - Document tagging strategy in CONTRIBUTING.md
    - Script to auto-tag on phase completion:
      scripts/tag-checkpoint.sh "phase-01-complete"
    
    CI workflow (optional but recommended):
    - GitHub Action that tags on main branch pushes
    - Tag messages describe phase state
    
    Manual tagging for now:
    ```bash
    git tag -a phase-01-plan-01 -m "Phase 1, Plan 1: Foundation layer complete"
    git tag -a phase-01-complete -m "Phase 1: Core Infrastructure MVP complete"
    ```
    
    Rollback instructions in README:
    ```bash
    git checkout phase-01-complete  # Rollback to stable state
    ```
    
    Test: Create test tag, verify checkout works.
  </action>
  <verify>git tag -l | grep phase-01</verify>
  <done>Tags document progress; rollback instructions clear; workflow established</done>
</task>

<task type="auto">
  <name>Task 5: CLI Main Entry Point</name>
  <files>src/cli/main.py, tests/cli/test_main.py</files>
  <action>
    Create CLI entry point:
    - butler --help: Show all commands
    - butler doctor: Run health check
    - butler process-voice: Trigger voice processing (for launchd)
    - butler version: Show version
    - butler config: Open config in editor (Phase 12 TUI placeholder)
    
    Use Click or argparse for CLI framework.
    
    Structure:
    ```python
    @click.group()
    def cli():
        pass
    
    @cli.command()
    def doctor():
        check_dependencies()
    
    @cli.command()
    def process_voice():
        # Trigger voice input scan
        pass
    ```
    
    Test: All commands respond, help text accurate.
  </action>
  <verify>python -m pytest tests/cli/test_main.py -v && butler --help</verify>
  <done>All CLI commands work; help text clear; entry point functional</done>
</task>

</tasks>

<verification>
1. Fresh install test: Clean VM/container, run install.sh, verify butler works
2. Doctor test: Remove Ollama, verify doctor reports error; reinstall, verify passes
3. Tag test: Create phase-01-complete tag, verify rollback works
4. CLI test: All commands execute without error
5. Integration: install.sh → butler doctor → butler process-voice works
</verification>

<success_criteria>
- install.sh runs successfully on fresh macOS
- butler doctor reports all dependencies
- butler doctor --fix downloads missing models
- Git tags created for rollback points
- CLI entry point shows all commands
- Package installs via pip
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-04-SUMMARY.md`
</output>

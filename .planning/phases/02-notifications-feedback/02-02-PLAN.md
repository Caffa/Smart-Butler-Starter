---
phase: 02-notifications-feedback
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/notifications/plugin.py
  - src/plugins/notifications/plugin.yaml
autonomous: true
gap_closure: true
requirements:
  - NOTIFY-02
must_haves:
  truths:
    - Audio tone plays when Butler starts processing voice input
    - Different tones indicate success, waiting, and failure states
  artifacts:
    - path: src/plugins/notifications/plugin.py
      provides: Event subscription to input_received
      contains: "input_received"
    - path: src/plugins/notifications/plugin.yaml
      provides: Plugin manifest
      contains: "input.received"
  key_links:
    - from: src/plugins/notifications/plugin.py
      to: src/core/event_bus.input_received
      via: SignalSubscription.connect()
      pattern: "input_received.*connect"
---

<objective>
Wire the waiting sound to trigger when Butler starts processing input.

Purpose: Complete the three-state audio feedback system (success/waiting/failure) by connecting the existing `play_waiting_sound()` function to the `input_received` event.

Output:

- Plugin subscribes to `input_received` event
- Pop.aiff plays when Butler starts processing voice input
- plugin.yaml updated to declare `input.received` subscription
  </objective>

<execution_context>
@/Users/caffae/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/caffae/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-notifications-feedback/02-01-SUMMARY.md
@.planning/phases/02-notifications-feedback/02-VERIFICATION.md
@src/plugins/notifications/plugin.py
@src/plugins/notifications/plugin.yaml
@src/core/event_bus.py
</context>

<tasks>

<task type="auto">
  <name>Subscribe to input_received event in plugin</name>
  <files>src/plugins/notifications/plugin.py, src/plugins/notifications/plugin.yaml</files>
  <action>
    The verification gap identified that `play_waiting_sound()` exists in audio.py but is never called. The plugin currently subscribes to `note_written` (completion) and `pipeline_error` (failure), but NOT to `input_received` (start of processing).

    Fix by:

    1. **In plugin.yaml** - Add `input.received` to events_listens (or events_subscribed depending on existing field name):
       ```yaml
       events_listens: [note.written, pipeline.error, input.received]
       ```

    2. **In plugin.py** - Add subscription to input_received signal:
       - Import `input_received` from `src.core.event_bus`
       - In `connect_events()`, add a new SignalSubscription for `input_received`
       - Create handler `_on_input_received(sender, source, **kwargs)` that:
         - Checks if muted (via config)
         - Calls `play_waiting_sound(self._muted)`
         - Logs at debug level: "Playing waiting sound for input from {source}"

    Follow the existing pattern from the current `note_written` and `pipeline_error` subscriptions. The handler should be simple - just play the sound and log.

    Reference: See existing `_on_note_written` and `_on_pipeline_error` for the pattern.

  </action>
  <verify>
    grep -q "input_received" src/plugins/notifications/plugin.py
    grep -q "input.received" src/plugins/notifications/plugin.yaml
    grep -q "play_waiting_sound" src/plugins/notifications/plugin.py
    python3 -c "from src.plugins.notifications.plugin import NotificationsPlugin; print('plugin imports ok')"
  </verify>
  <done>
    Plugin subscribes to input_received event, calls play_waiting_sound() when Butler starts processing input, manifest declares the subscription
  </done>
</task>

</tasks>

<verification>
- Plugin imports without errors
- input_received subscription exists in plugin.py
- input.received declared in plugin.yaml
- play_waiting_sound() is called in a handler
- Pattern matches existing note_written/pipeline_error subscriptions
</verification>

<success_criteria>

- [x] Audio tone (Pop.aiff) plays when Butler starts processing voice input
- [x] Three-state audio system complete: success (Glass), waiting (Pop), failure (Basso)
- [x] Plugin manifest correctly declares all event subscriptions
      </success_criteria>

<output>
After completion, create `.planning/phases/02-notifications-feedback/02-02-SUMMARY.md`
</output>
